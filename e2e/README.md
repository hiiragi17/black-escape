# E2Eテスト

このディレクトリには、Playwrightを使用したEnd-to-Endテストが含まれています。

## テストの内容

### story-flow.spec.ts
基本的なストーリーフローが破綻なく続いているかを確認するテストです。

テスト項目：
- トップページの表示確認
- 設定ページへの遷移
- ゲーム開始の確認
- バッドエンディングまでのフロー
- グッドエンディングまでのフロー
- エンディングからタイトルへの遷移
- 選択肢の表示確認
- タイピングアニメーションの動作確認

### story-integrity.spec.ts
**ストーリーデータの完全性を自動検証するテスト**です。新しくストーリーを追加した際に、全てのパスが正しく繋がっているかを自動的にチェックします。

テスト項目：
- **データ構造の検証**
  - 存在しないシーンへの参照がないか
  - 到達不可能なシーン（デッドコード）の検出
  - startシーンの存在確認
  - エンディングシーンの存在確認
  - 完全なストーリーパスの検証

- **全ストーリーパスの自動E2Eテスト**
  - story.tsに定義された全てのストーリーパスを自動的に検出
  - 各パスをブラウザで実際に辿って動作確認
  - 選択肢の遷移が正しく機能するか検証
  - 各エンディングに正しく到達できるか確認

このテストは、ストーリーを追加・変更するたびに自動的に全パターンをテストするため、**破綻したストーリーや到達できないエンディングを即座に検出**できます。

### utils/story-validator.ts
ストーリーデータの完全性をチェックするユーティリティ関数群です。
テストコード以外でも使用できます。

## 事前準備

```bash
# 依存関係のインストール
npm install

# Playwrightブラウザのインストール
npx playwright install
```

## テストの実行方法

```bash
# 全てのテストを実行（ヘッドレスモード）
npm run test:e2e

# UIモードでテストを実行（デバッグに便利）
npm run test:e2e:ui

# ブラウザを表示してテストを実行
npm run test:e2e:headed

# 特定のテストファイルのみ実行
npx playwright test e2e/story-flow.spec.ts

# 特定のブラウザでのみ実行
npx playwright test --project=chromium
```

## テスト結果の確認

テスト実行後、結果は以下の場所に保存されます：

- **HTMLレポート**: `playwright-report/index.html`
  - `npx playwright show-report` で開けます
- **スクリーンショット**: `test-results/` (失敗時のみ)
- **ビデオ**: `test-results/` (失敗時のみ)

## CI/CD

GitHub ActionsなどのCI環境では、`CI`環境変数が設定されている場合、以下の設定が自動的に適用されます：
- 失敗時に2回まで再試行
- ワーカー数を1に制限
- `forbidOnly`が有効化（`.only`を使用したテストがあればエラー）

## トラブルシューティング

### テストが失敗する場合

1. 開発サーバーが起動していることを確認
2. `npm run dev` で手動起動して問題がないか確認
3. `npx playwright test --debug` でデバッグモードで実行

### ブラウザが起動しない場合

```bash
# ブラウザの再インストール
npx playwright install --force
```

### タイムアウトエラーが発生する場合

- ネットワークが遅い場合は `playwright.config.ts` の `timeout` 値を増やしてください
- タイピングアニメーションの待機時間が足りない場合は、各テストの `timeout` パラメータを調整してください
